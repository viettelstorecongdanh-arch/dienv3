<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docx Auto-Fill Pro (Super Stable)</title>
    
    <!-- 1. TH∆Ø VI·ªÜN REACT & UI -->
    <script crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. TH∆Ø VI·ªÜN X·ª¨ L√ù WORD (B·∫£n ·ªïn ƒë·ªãnh nh·∫•t) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.29.0/docxtemplater.js"></script>
    <script src="https://unpkg.com/pizzip@3.1.1/dist/pizzip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Preview -->
    <script src="https://unpkg.com/docx-preview@0.1.15/dist/docx-preview.js"></script>

    <style>
        body { background: #f1f5f9; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; background: #eff6ff; }
        .tab-inactive { color: #64748b; hover:bg-gray-50; }
        .input-std { width: 100%; padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 6px; outline: none; font-size: 14px; transition: 0.2s; }
        .input-std:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.2); }
        .btn { transition: all 0.2s; active:scale-95; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        function App() {
            // --- STATE ---
            const [activeTab, setActiveTab] = useState('form');
            const [file, setFile] = useState(null);
            const [fileBuffer, setFileBuffer] = useState(null);
            const [loading, setLoading] = useState(false);
            const [msg, setMsg] = useState({ text: '', type: '' }); // type: success/error
            
            // Data Input
            const [form, setForm] = useState({ MA_KH: '', TEN_KH: '', SO_TIEN: '', NOI_DUNG: '', SO_TIEN_CHU: '', SO_TIEN_FMT: '' });
            const [jsonStr, setJsonStr] = useState('');

            // Outputs
            const [previewBlob, setPreviewBlob] = useState(null);
            const [downloadData, setDownloadData] = useState(null); // { blob, name }
            const previewRef = useRef(null);

            // --- 1. LOGIC TI·ªÄN T·ªÜ (L√†m tr√≤n + Format) ---
            const processMoney = (val) => {
                if (!val) return { raw: 0, fmt: '', text: '' };
                let num = parseFloat(val);
                if (isNaN(num)) return { raw: 0, fmt: val, text: '' };

                // L√†m tr√≤n l√™n h√†ng ngh√¨n (VD: 54321 -> 55000)
                num = Math.ceil(num / 1000) * 1000;
                
                const fmt = num.toLocaleString('vi-VN');
                const text = `(B·∫±ng ch·ªØ: ... ƒë·ªìng)`; 
                return { raw: num, fmt, text };
            };

            const handleMoneyChange = (e) => {
                const val = e.target.value;
                const { fmt, text } = processMoney(val);
                setForm(prev => ({ ...prev, SO_TIEN: val, SO_TIEN_FMT: fmt, SO_TIEN_CHU: text }));
            };

            // --- 2. X·ª¨ L√ù FILE M·∫™U ---
            const handleFile = (e) => {
                const f = e.target.files[0];
                if (!f) return;
                
                // Reset state
                setMsg({ text: '‚è≥ ƒêang ƒë·ªçc file...', type: 'info' });
                setFile(f);
                setPreviewBlob(null);
                setDownloadData(null);
                if(previewRef.current) previewRef.current.innerHTML = '';

                const reader = new FileReader();
                reader.readAsArrayBuffer(f);
                reader.onload = (evt) => {
                    if(evt.target.result && evt.target.result.byteLength > 0) {
                        setFileBuffer(evt.target.result);
                        setMsg({ text: `‚úÖ ƒê√£ t·∫£i: ${f.name} (${(f.size/1024).toFixed(1)} KB)`, type: 'success' });
                    } else {
                        setMsg({ text: '‚ùå File l·ªói ho·∫∑c r·ªóng!', type: 'error' });
                    }
                };
                reader.onerror = () => setMsg({ text: '‚ùå L·ªói ƒë·ªçc file', type: 'error' });
            };

            // --- 3. T·∫†O FILE (Generate) ---
            const generate = async () => {
                if (!fileBuffer) return setMsg({ text: '‚ö†Ô∏è Ch∆∞a ch·ªçn file m·∫´u!', type: 'error' });
                
                setLoading(true);
                setMsg({ text: '‚öôÔ∏è ƒêang x·ª≠ l√Ω...', type: 'info' });
                setPreviewBlob(null);
                setDownloadData(null);

                // Delay nh·∫π ƒë·ªÉ UI k·ªãp render loading
                await new Promise(r => setTimeout(r, 50));

                try {
                    // A. Chu·∫©n b·ªã d·ªØ li·ªáu
                    let dataList = [];
                    if (activeTab === 'form') {
                        // D·ªØ li·ªáu t·ª´ Form
                        const { fmt, text } = processMoney(form.SO_TIEN);
                        dataList = [{ ...form, SO_TIEN: fmt, SO_TIEN_CHU: text }];
                    } else {
                        // D·ªØ li·ªáu t·ª´ JSON
                        if (!jsonStr.trim()) throw new Error("√î nh·∫≠p JSON ƒëang tr·ªëng!");
                        try {
                            const parsed = JSON.parse(jsonStr);
                            dataList = Array.isArray(parsed) ? parsed : [parsed];
                        } catch (e) {
                            throw new Error("JSON sai c√∫ ph√°p (Ki·ªÉm tra d·∫•u ngo·∫∑c, d·∫•u ph·∫©y)");
                        }
                    }

                    // B. X·ª≠ l√Ω Template (PizZip + Docxtemplater)
                    const zip = new JSZip(); // D√πng ƒë·ªÉ n√©n n·∫øu nhi·ªÅu file
                    let firstDocBlob = null; // ƒê·ªÉ preview

                    dataList.forEach((item, idx) => {
                        // X·ª≠ l√Ω ti·ªÅn cho item trong JSON n·∫øu c·∫ßn
                        if (item.SO_TIEN && typeof item.SO_TIEN === 'number') {
                            const { fmt, text } = processMoney(item.SO_TIEN);
                            item.SO_TIEN = fmt;
                            if(!item.SO_TIEN_CHU) item.SO_TIEN_CHU = text;
                        }

                        const pzip = new PizZip(fileBuffer);
                        const doc = new window.docxtemplater(pzip, { paragraphLoop: true, linebreaks: true });
                        
                        doc.render(item);

                        const blob = doc.getZip().generate({
                            type: "blob",
                            mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                        });

                        const fname = `${item.MA_KH || 'Doc'}_${idx+1}.docx`;
                        
                        if (idx === 0) firstDocBlob = blob; // L∆∞u file ƒë·∫ßu ƒë·ªÉ preview
                        zip.file(fname, blob); // Th√™m v√†o zip
                    });

                    // C. Chu·∫©n b·ªã Download Data
                    if (dataList.length === 1) {
                        setDownloadData({ blob: firstDocBlob, name: `${dataList[0].MA_KH || 'KetQua'}.docx` });
                    } else {
                        const zipContent = await zip.generateAsync({ type: "blob" });
                        setDownloadData({ blob: zipContent, name: "Ket_Qua_Hang_Loat.zip" });
                    }

                    // D. Render Preview
                    if (firstDocBlob && previewRef.current) {
                        await window.docx.renderAsync(firstDocBlob, previewRef.current);
                    }

                    setMsg({ text: `‚úÖ Th√†nh c√¥ng! ƒê√£ t·∫°o ${dataList.length} file.`, type: 'success' });

                } catch (err) {
                    console.error(err);
                    setMsg({ text: `‚ùå L·ªói: ${err.message}`, type: 'error' });
                } finally {
                    setLoading(false);
                }
            };

            // --- 4. T·∫¢I XU·ªêNG (FORCE DOWNLOAD) ---
            const forceDownload = () => {
                if (!downloadData) return;
                try {
                    // T·∫°o th·∫ª a ·∫£o ƒë·ªÉ click -> C√°ch n√†y tr√¨nh duy·ªát kh√¥ng ch·∫∑n ƒë∆∞·ª£c n·∫øu user click
                    const url = window.URL.createObjectURL(downloadData.blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.setAttribute('download', downloadData.name);
                    document.body.appendChild(link);
                    link.click();
                    
                    // Cleanup
                    setTimeout(() => {
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(url);
                    }, 100);
                } catch (e) {
                    alert("L·ªói t·∫£i xu·ªëng: " + e.message);
                }
            };

            return (
                <div className="flex h-screen overflow-hidden">
                    {/* LEFT SIDEBAR: Controls */}
                    <div className="w-full md:w-[450px] bg-white border-r flex flex-col shadow-xl z-10 shrink-0">
                        <div className="p-5 border-b bg-slate-50">
                            <h1 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                                ‚ö° Docx Auto-Fill <span className="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">Pro</span>
                            </h1>
                        </div>

                        <div className="flex-1 overflow-y-auto p-5 space-y-5">
                            {/* 1. Upload */}
                            <div className={`border-2 border-dashed rounded-xl p-6 text-center transition-colors ${file ? 'border-green-400 bg-green-50' : 'border-slate-300 hover:border-blue-400'}`}>
                                <input type="file" accept=".docx" onChange={handleFile} className="hidden" id="fileUpload"/>
                                <label htmlFor="fileUpload" className="cursor-pointer block">
                                    <div className="text-3xl mb-2">{file ? 'üìÑ' : 'üìÇ'}</div>
                                    <div className="font-medium text-sm text-slate-700">{file ? file.name : "Nh·∫•n ƒë·ªÉ ch·ªçn file m·∫´u (.docx)"}</div>
                                </label>
                            </div>

                            {/* 2. Tabs */}
                            <div className="flex border-b border-slate-200">
                                <button onClick={()=>setActiveTab('form')} className={`flex-1 py-2 text-sm font-bold ${activeTab==='form' ? 'tab-active' : 'tab-inactive'}`}>Nh·∫≠p Form</button>
                                <button onClick={()=>setActiveTab('json')} className={`flex-1 py-2 text-sm font-bold ${activeTab==='json' ? 'tab-active' : 'tab-inactive'}`}>D√°n JSON</button>
                            </div>

                            {/* 3. Inputs */}
                            <div className="bg-white min-h-[200px]">
                                {activeTab === 'form' && (
                                    <div className="space-y-3 pt-3 animate-in fade-in">
                                        <div className="grid grid-cols-2 gap-3">
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 mb-1">M√£ Hƒê</label>
                                                <input className="input-std" value={form.MA_KH} onChange={e=>setForm({...form, MA_KH:e.target.value})} placeholder="HD001" />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 mb-1">S·ªë ti·ªÅn (S·ªë)</label>
                                                <input type="number" className="input-std font-bold text-blue-600" value={form.SO_TIEN} onChange={handleMoneyChange} placeholder="50000" />
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 mb-1">H·ªç t√™n kh√°ch h√†ng</label>
                                            <input className="input-std" value={form.TEN_KH} onChange={e=>setForm({...form, TEN_KH:e.target.value})} placeholder="Nguy·ªÖn VƒÉn A" />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 mb-1">N·ªôi dung thu</label>
                                            <textarea className="input-std" rows="3" value={form.NOI_DUNG} onChange={e=>setForm({...form, NOI_DUNG:e.target.value})} placeholder="Thanh to√°n ti·ªÅn ƒëi·ªán..."></textarea>
                                        </div>
                                        
                                        {/* Preview Money Logic */}
                                        <div className="text-xs bg-slate-100 p-2 rounded text-slate-600">
                                            <div>Format: <b>{form.SO_TIEN_FMT || '0'}</b></div>
                                            <div className="italic">{form.SO_TIEN_CHU}</div>
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'json' && (
                                    <div className="pt-3 h-full">
                                        <textarea 
                                            value={jsonStr} onChange={e=>setJsonStr(e.target.value)}
                                            className="w-full h-64 p-3 font-mono text-xs border rounded bg-slate-900 text-green-400 resize-none outline-none"
                                            placeholder='[&#10;  { "MA_KH": "KH1", "SO_TIEN": 50000 },&#10;  { "MA_KH": "KH2", "SO_TIEN": 123456 }&#10;]'
                                        ></textarea>
                                        <div className="text-xs text-slate-400 mt-1">* T·ª± ƒë·ªông l√†m tr√≤n s·ªë ti·ªÅn khi x·ª≠ l√Ω</div>
                                    </div>
                                )}
                            </div>

                            {/* 4. Action Buttons */}
                            <div className="space-y-3 pt-2">
                                <button onClick={generate} disabled={loading} className={`w-full py-3 rounded-lg font-bold text-white shadow-lg btn flex justify-center items-center gap-2 ${loading ? 'bg-slate-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'}`}>
                                    {loading ? "‚è≥ ƒêang x·ª≠ l√Ω..." : "‚ö° TH·ª∞C HI·ªÜN & XEM TR∆Ø·ªöC"}
                                </button>
                                
                                {msg.text && (
                                    <div className={`text-center text-sm font-medium p-2 rounded ${msg.type === 'error' ? 'bg-red-50 text-red-600' : 'bg-green-50 text-green-700'}`}>
                                        {msg.text}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* RIGHT CONTENT: Preview */}
                    <div className="flex-1 bg-slate-100 flex flex-col h-full overflow-hidden relative">
                        <div className="h-16 bg-white border-b flex justify-between items-center px-6 shrink-0 shadow-sm z-10">
                            <div className="text-sm font-bold text-slate-400 uppercase tracking-wider">Khu v·ª±c Xem tr∆∞·ªõc</div>
                            {downloadData && (
                                <button onClick={forceDownload} className="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg font-bold shadow-lg transform transition active:scale-95 flex items-center gap-2">
                                    <span>üíæ T·∫£i xu·ªëng {activeTab === 'json' && jsonStr.includes('[') ? 'ZIP' : 'File'}</span>
                                </button>
                            )}
                        </div>

                        <div className="flex-1 overflow-auto p-8 flex justify-center">
                            <div ref={previewRef} className="bg-white shadow-2xl min-h-[297mm] w-[210mm] transition-all duration-500">
                                {/* Preview content rendered here */}
                            </div>
                            {!downloadData && !loading && (
                                <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                                    <div className="text-6xl mb-4 opacity-20">üìÑ</div>
                                    <div className="text-slate-400 font-medium">Ch∆∞a c√≥ k·∫øt qu·∫£ ƒë·ªÉ hi·ªÉn th·ªã</div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
